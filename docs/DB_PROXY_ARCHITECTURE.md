# 🔄 Архитектура Database Proxy для Firebird

## 📋 Общая концепция

### Проблема
- Firebird сервер имеет whitelist IP-адресов
- Нужен доступ с множества устройств с разных локаций
- Невозможно добавить все IP-адреса пользователей в whitelist

### Решение
Создать **Database Gateway/Proxy API** на облачной платформе (Railway.com) с фиксированным IP-адресом.

---

## 🏗️ Архитектура системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          КЛИЕНТСКАЯ СТОРОНА                             │
│                                                                           │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                   │
│  │ Устройство 1│   │ Устройство 2│   │ Устройство N│                   │
│  │  (любой IP) │   │  (любой IP) │   │  (любой IP) │                   │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘                   │
│         │                  │                  │                          │
│         │   HTTP/HTTPS     │                  │                          │
│         │   + Bearer Token │                  │                          │
│         └──────────────────┴──────────────────┘                          │
│                            │                                              │
└────────────────────────────┼──────────────────────────────────────────────┘
                             │
                    POST /api/query
                    Authorization: Bearer <token>
                    Body: { "query": "SELECT ...", "params": [...] }
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        PROXY API (Railway.com)                          │
│                       Фиксированный IP адрес                            │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  FastAPI / Flask Application                                    │   │
│  │                                                                   │   │
│  │  1. ✅ Проверка Bearer Token                                     │   │
│  │  2. ✅ Валидация SQL запроса (только SELECT)                     │   │
│  │  3. ✅ Rate Limiting (защита от перегрузки)                      │   │
│  │  4. 📝 Логирование запросов                                      │   │
│  │  5. 🔒 Шифрование передачи данных (HTTPS)                        │   │
│  │  6. 🚫 Защита от SQL инъекций                                    │   │
│  │  7. ⏱️  Таймауты запросов                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
└─────────────────────────────┬─────────────────────────────────────────────┘
                              │
                     Firebird Protocol
                     (Единственный IP в whitelist)
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       FIREBIRD DATABASE SERVER                          │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  IP Whitelist:                                                   │   │
│  │  - Railway.com статический IP  ✅                                │   │
│  │  - Другие доверенные адреса                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
│  📊 Database: GEORGIA.GDB (или алиас DK_GEORGIA)                       │
│  🔒 Порт: 3055                                                          │
│  👤 User: SYSDBA                                                        │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🔐 Система безопасности

### 1. Аутентификация (Bearer Token)
```python
# На стороне клиента
headers = {
    "Authorization": f"Bearer {PROXY_API_TOKEN}",
    "Content-Type": "application/json"
}
```

### 2. Многоуровневая защита
```
Клиент → Token Auth → SQL Validation → Rate Limit → Firebird DB
           ↓              ↓                ↓
        ❌ Отказ      ❌ Опасный SQL   ❌ Слишком много
```

### 3. Валидация SQL запросов
- ✅ Только SELECT запросы
- ❌ Запрет INSERT, UPDATE, DELETE, DROP, ALTER
- ❌ Запрет множественных запросов
- ❌ Запрет EXECUTE BLOCK / PROCEDURE

### 4. Rate Limiting
- Максимум запросов в минуту на токен
- Защита от DDoS атак
- Автоматическое блокирование при превышении

---

## 📡 API Endpoints

### POST /api/query
Выполнение SELECT запроса к БД

**Request:**
```json
{
  "query": "SELECT ID, NAME FROM STORGRP WHERE ID = ?",
  "params": [1]
}
```

**Response (Success):**
```json
{
  "success": true,
  "data": [
    {"ID": 1, "NAME": "Магазин 1"}
  ],
  "rows_count": 1,
  "execution_time": 0.234,
  "timestamp": "2025-10-17T12:34:56"
}
```

**Response (Error):**
```json
{
  "success": false,
  "error": "SQL validation failed: UPDATE not allowed",
  "timestamp": "2025-10-17T12:34:56"
}
```

---

### GET /api/health
Проверка работоспособности proxy

**Response:**
```json
{
  "status": "healthy",
  "database_connected": true,
  "uptime_seconds": 3600,
  "version": "1.0.0"
}
```

---

### GET /api/tables
Получить список таблиц в БД (для отладки)

**Response:**
```json
{
  "success": true,
  "tables": ["STORGRP", "STORZAKAZDT", "STORZDTGDS", ...],
  "count": 45
}
```

---

## 🚀 Deployment на Railway.com

### Преимущества Railway.com
1. ✅ **Фиксированный статический IP** - можно добавить в whitelist
2. ✅ **Автоматический Deploy из GitHub** - CI/CD из коробки
3. ✅ **Масштабирование** - автоматическое при росте нагрузки
4. ✅ **Мониторинг и логи** - встроенные инструменты
5. ✅ **HTTPS из коробки** - автоматические SSL сертификаты
6. ✅ **Environment Variables** - безопасное хранение секретов
7. ✅ **Быстрый старт** - деплой за минуты

### Альтернативы
- **Fly.io** - аналогичный сервис
- **Render.com** - еще один вариант
- **DigitalOcean App Platform** - если нужен полный контроль

---

## 🔧 Технический стек

### Backend (Proxy API)
```python
FastAPI          # Современный async веб-фреймворк
fdb              # Firebird database driver
pydantic         # Валидация данных
slowapi          # Rate limiting
python-jose      # JWT токены (опционально)
uvicorn          # ASGI сервер
python-dotenv    # Управление env переменными
```

### Deployment
```
Railway.com      # Хостинг платформа
Docker           # Контейнеризация
GitHub Actions   # CI/CD (опционально)
```

---

## 📝 Environment Variables (Railway)

```bash
# Database connection
DB_HOST=85.114.224.45
DB_PORT=3055
DB_NAME=DK_GEORGIA
DB_USER=SYSDBA
DB_PASSWORD=masterkey

# Security
API_TOKEN=your-super-secret-token-here-change-me
ALLOWED_ORIGINS=*  # Или конкретные домены

# Rate limiting
RATE_LIMIT_PER_MINUTE=60
RATE_LIMIT_PER_HOUR=1000

# Timeouts
DB_CONNECTION_TIMEOUT=10
DB_QUERY_TIMEOUT=30

# Logging
LOG_LEVEL=INFO
```

---

## 📊 Мониторинг и логирование

### Логируемые события
```python
✅ Успешные подключения
✅ Успешные запросы (время выполнения, количество строк)
❌ Ошибки подключения к БД
❌ Отклоненные запросы (невалидный SQL)
🚫 Попытки несанкционированного доступа (неверный токен)
⏱️  Превышение rate limit
📊 Статистика использования
```

### Метрики для мониторинга
- Количество запросов в секунду
- Среднее время выполнения запросов
- Количество ошибок
- Использование памяти
- CPU usage
- Количество активных соединений с БД

---

## 🔄 Workflow использования

### Шаг 1: Первоначальная настройка (один раз)
1. Задеплоить Proxy API на Railway.com
2. Получить статический IP адрес Railway
3. Добавить этот IP в whitelist на Firebird сервере
4. Сгенерировать и настроить API_TOKEN

### Шаг 2: Настройка клиента
1. Установить переменные окружения:
   ```bash
   PROXY_API_URL=https://your-app.railway.app
   PROXY_API_TOKEN=your-secret-token
   ```

### Шаг 3: Использование в коде
```python
from proxy_client import ProxyDatabaseConnector

# Создать коннектор к proxy
connector = ProxyDatabaseConnector(
    api_url=os.getenv('PROXY_API_URL'),
    api_token=os.getenv('PROXY_API_TOKEN')
)

# Использовать как обычный коннектор
df = connector.execute_query_to_dataframe(
    "SELECT * FROM STORGRP WHERE ID = ?",
    params=(1,)
)
```

---

## 🔒 Best Practices безопасности

1. **Никогда не коммитить токены в Git**
   - Использовать `.env` файлы
   - Добавить `.env` в `.gitignore`

2. **Ротация токенов**
   - Менять API_TOKEN периодически
   - Возможность иметь несколько активных токенов

3. **Мониторинг подозрительной активности**
   - Алерты при множественных неудачных попытках
   - Логирование всех отклоненных запросов

4. **HTTPS обязателен**
   - Railway предоставляет это автоматически
   - Никогда не использовать HTTP в production

5. **Минимальные привилегии**
   - Proxy использует READ-ONLY доступ
   - Валидация всех входящих запросов

---

## 🎯 Преимущества архитектуры

### Для разработчиков
- ✅ Единая точка доступа к БД
- ✅ Не нужно настраивать Firebird на каждом устройстве
- ✅ Простой HTTP API вместо Firebird протокола
- ✅ Автоматическое логирование всех операций

### Для администраторов
- ✅ Централизованный контроль доступа
- ✅ Один IP адрес в whitelist
- ✅ Мониторинг всех запросов
- ✅ Защита от несанкционированного доступа

### Для безопасности
- ✅ READ-ONLY режим
- ✅ Валидация всех SQL запросов
- ✅ Rate limiting защищает от атак
- ✅ Шифрование передачи данных (HTTPS)

---

## 📈 Масштабируемость

### Текущая нагрузка
- 10-50 пользователей одновременно
- ~1000 запросов в час
- Railway справится легко

### Будущий рост
- До 1000 пользователей
- До 100,000 запросов в день
- Можно масштабировать horizontally на Railway

### Оптимизация
- Connection pooling к Firebird
- Кеширование частых запросов (опционально)
- Load balancing (при необходимости)

---

## 🚦 Этапы внедрения

### Фаза 1: Разработка (1-2 дня)
- [ ] Создать FastAPI приложение
- [ ] Реализовать аутентификацию
- [ ] Реализовать SQL валидацию
- [ ] Добавить rate limiting
- [ ] Настроить логирование
- [ ] Написать тесты

### Фаза 2: Deployment (1 день)
- [ ] Создать проект на Railway.com
- [ ] Настроить environment variables
- [ ] Задеплоить приложение
- [ ] Получить статический IP
- [ ] Добавить IP в whitelist Firebird

### Фаза 3: Интеграция (1 день)
- [ ] Создать клиентскую библиотеку
- [ ] Обновить текущий проект
- [ ] Протестировать подключение
- [ ] Обновить документацию

### Фаза 4: Production (ongoing)
- [ ] Мониторинг работы
- [ ] Настройка алертов
- [ ] Ротация токенов
- [ ] Оптимизация по мере использования

---

## 💡 Дополнительные возможности (будущее)

### Кеширование
```python
# Кешировать результаты справочников
@cache(ttl=3600)  # 1 час
def get_stores_list():
    return proxy.query("SELECT ID, NAME FROM STORGRP")
```

### WebSocket для real-time
```python
# Для live обновлений (если нужно)
@app.websocket("/ws/updates")
async def websocket_updates(websocket: WebSocket):
    # Push уведомления о новых данных
    pass
```

### Batch запросы
```python
# Выполнить несколько SELECT за один HTTP запрос
{
    "queries": [
        {"query": "SELECT * FROM STORGRP"},
        {"query": "SELECT * FROM GOODS"}
    ]
}
```

### GraphQL API (опционально)
```graphql
query {
  stores {
    id
    name
    sales {
      date
      amount
    }
  }
}
```

---

## 📞 Поддержка и документация

### Документация API
- Автоматическая Swagger UI: `/docs`
- ReDoc документация: `/redoc`
- OpenAPI спецификация: `/openapi.json`

### Мониторинг
- Railway Dashboard: логи, метрики, алерты
- Custom health checks
- Интеграция с Sentry (опционально)

---

## ✅ Чеклист готовности к production

- [ ] API задеплоен на Railway.com
- [ ] Статический IP добавлен в Firebird whitelist
- [ ] API_TOKEN сгенерирован и распространен
- [ ] Rate limiting настроен
- [ ] Логирование работает корректно
- [ ] HTTPS включен (автоматически на Railway)
- [ ] Health checks настроены
- [ ] Клиентская библиотека создана
- [ ] Документация обновлена
- [ ] Тестирование пройдено успешно

---

## 🎓 Обучение команды

### Для пользователей
1. Получить API_TOKEN от администратора
2. Добавить в `.env` файл:
   ```bash
   PROXY_API_URL=https://your-app.railway.app
   PROXY_API_TOKEN=ваш-токен
   ```
3. Использовать как обычную БД (код не меняется!)

### Для администраторов
1. Управление токенами через Railway Dashboard
2. Мониторинг использования
3. Ротация токенов при необходимости
4. Масштабирование при росте нагрузки

---

**Дата создания:** 2025-10-17  
**Версия:** 1.0  
**Статус:** Готов к внедрению 🚀






